<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Generator Chatbot</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f4f8;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        #chat-container {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }
        .user-message {
            background-color: #3498db;
            color: white;
            margin-left: auto;
        }
        .bot-message {
            background-color: #ecf0f1;
            color: #34495e;
        }
        #user-input {
            width: calc(100% - 120px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background-color: #2980b9;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #3498db;
        }
        #send-button {
            width: 100px;
        }
        #button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        pre {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        code {
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
        }
        .code-block-container {
            position: relative;
        }
        .code-block {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.4;
            overflow-x: auto;
        }
        .copy-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #2980b9;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .copy-button:hover {
            background-color: #3498db;
        }
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 10px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #2196F3;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        .toggle-label {
            margin-right: 10px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .settings-button {
            position: fixed;
            top: 10px;
            right: 10px;
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
        }
        .add-git-context {
            position: fixed;
            top: 50px;
            right: 10px;
            padding: 5px 10px;
            background-color: #2980b9;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .add-git-context:hover {
            background-color: #3498db;
        }
    </style>
</head>
<body>
    <h1>Project Generator Chatbot</h1>
    <div class="toggle-container">
        <span class="toggle-label">Quick</span>
        <label class="toggle-switch">
            <input type="checkbox" id="mode-toggle">
            <span class="toggle-slider"></span>
        </label>
        <span class="toggle-label">Smart</span>
    </div>
    <div id="chat-container"></div>
    <div>
        <input type="text" id="user-input" placeholder="Type your message here...">
        <button id="send-button">Send</button>
    </div>
    <div id="button-container">
        <button id="html-button">Generate HTML</button>
        <button id="css-button">Generate CSS</button>
        <button id="js-button">Generate JS</button>
        <button id="question-button">Ask Question</button>
        <button id="implementation-button">Implementation Advice</button>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Settings</h2>
            <label for="git-repo-path">Git Repository Path:</label>
            <input type="text" id="git-repo-path" placeholder="Enter the path to your Git repository">
            <button id="save-settings">Save</button>
        </div>
    </div>

    <button id="settings-button" class="settings-button">⚙️</button>
    <button id="add-git-context" class="add-git-context" style="display: none;">Add Git Context</button>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const htmlButton = document.getElementById('html-button');
        const cssButton = document.getElementById('css-button');
        const jsButton = document.getElementById('js-button');
        const questionButton = document.getElementById('question-button');
        const implementationButton = document.getElementById('implementation-button');
        const modeToggle = document.getElementById('mode-toggle');
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const closeButton = settingsModal.querySelector('.close');
        const saveSettingsButton = document.getElementById('save-settings');
        const gitRepoPathInput = document.getElementById('git-repo-path');
        const addGitContextButton = document.getElementById('add-git-context');

        let conversation = [];
        let currentHtml = '';
        let currentCss = '';
        let currentJs = '';
        let projectContext = '';
        let gitRepoContent = null;

        function cleanCodeBlock(code, language) {
            code = code.replace(new RegExp(`\`\`\`${language}\\s*\\n?|^\`\`\`|\\s*\`\`\`$`, 'g'), '');
            code = code.trim();
            return code;
        }

        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(isUser ? 'user-message' : 'bot-message');
            
            content = content.replace(/```(\w+)?\s*([\s\S]*?)```/g, (match, language, code) => {
                code = cleanCodeBlock(code, language);
                return `
                    <div class="code-block-container">
                        <pre class="code-block"><code>${escapeHtml(code)}</code></pre>
                        <button class="copy-button" data-code="${encodeURIComponent(code)}">Copy</button>
                    </div>
                `;
            });
            
            messageDiv.innerHTML = content;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            messageDiv.querySelectorAll('.copy-button').forEach(button => {
                button.addEventListener('click', handleCopyClick);
            });

            conversation.push({
                role: isUser ? 'user' : 'assistant',
                content: content
            });

            projectContext += `${isUser ? 'User' : 'Assistant'}: ${content}\n`;
        }

        function handleCopyClick(e) {
            const code = decodeURIComponent(e.target.getAttribute('data-code'));
            navigator.clipboard.writeText(code).then(() => {
                const originalText = e.target.textContent;
                e.target.textContent = 'Copied!';
                setTimeout(() => {
                    e.target.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }

        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        function getCurrentModel() {
            return modeToggle.checked ? 'claude-3-5-sonnet' : 'gpt-4o-mini';
        }

        async function generateContent(prompt) {
            const model = getCurrentModel();
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ model, prompt }),
                });
                const data = await response.json();
                console.log('API Response:', data);
                if (data.content) {
                    return data.content;
                } else if (data.error) {
                    console.error('API Error:', data.error);
                    return `Error: ${data.error}`;
                } else {
                    console.error('Unexpected API response format:', data);
                    return 'Error: Unexpected response format from the API.';
                }
            } catch (error) {
                console.error('Error generating content:', error);
                return 'Error generating content. Please check the console for more details.';
            }
        }

        async function handleSend() {
            const userMessage = userInput.value.trim();
            if (userMessage) {
                addMessage(userMessage, true);
                userInput.value = '';
                let prompt = `${projectContext}\n\nHuman: ${userMessage}\n\nAssistant: Please provide your response. If you include any code snippets, always wrap them in triple backticks (\`\`\`) for proper formatting.`;
                
                if (gitRepoContent) {
                    prompt = `Git Repository Content:\n${JSON.stringify(gitRepoContent, null, 2)}\n\n${prompt}`;
                }
                
                const response = await generateContent(prompt);
                addMessage(response);
            }
        }

        async function handleHtml() {
            const userMessage = userInput.value.trim();
            if (userMessage) {
                addMessage(userMessage, true);
            }
            userInput.value = '';
            const prompt = `Project context:\n${projectContext}\n\nCurrent HTML:\n${currentHtml}\n\nUser input: ${userMessage}\n\nPlease update or generate HTML based on the project context, current HTML, and user input. If starting fresh, create a complete HTML structure for the project described. Return only the HTML code without any explanation, comments, or markdown formatting. Do not include any text outside the HTML code.`;
            let newHtml = await generateContent(prompt);
            newHtml = cleanCodeBlock(newHtml, 'html');
            newHtml = newHtml.replace(/<!--[\s\S]*?-->/g, '');
            newHtml = newHtml.replace(/^([\s\S]*?html)?\s*<!DOCTYPE html>/i, '<!DOCTYPE html>');
            currentHtml = newHtml;
            addMessage("Updated HTML:");
            addMessage("```html\n" + currentHtml + "\n```");
        }

        async function handleCss() {
            const userMessage = userInput.value.trim();
            if (userMessage) {
                addMessage(userMessage, true);
            }
            userInput.value = '';
            const prompt = `Project context:\n${projectContext}\n\nCurrent CSS:\n${currentCss}\n\nUser input: ${userMessage}\n\nPlease update or generate CSS based on the project context, current CSS, and user input. If starting fresh, create complete styles for the project described. Return only the CSS code without any explanation, comments, or markdown formatting. Do not include any text outside the CSS code.`;
            let newCss = await generateContent(prompt);
            newCss = cleanCodeBlock(newCss, 'css');
            newCss = newCss.replace(/\/\*[\s\S]*?\*\//g, '');
            newCss = newCss.replace(/\/\/.*/g, '');
            currentCss = newCss;
            addMessage("Updated CSS:");
            addMessage("```css\n" + currentCss + "\n```");
        }

        async function handleJs() {
            const userMessage = userInput.value.trim();
            if (userMessage) {
                addMessage(userMessage, true);
            }
            userInput.value = '';
            const prompt = `Project context:\n${projectContext}\n\nCurrent JavaScript:\n${currentJs}\n\nUser input: ${userMessage}\n\nPlease update or generate JavaScript based on the project context, current JavaScript, and user input. If starting fresh, create complete functionality for the project described. Ensure all necessary functions and event listeners are included. Return only the JavaScript code without any explanation, comments, or markdown formatting. Do not include any text outside the JavaScript code.`;
            let newJs = await generateContent(prompt);
            newJs = cleanCodeBlock(newJs, 'javascript');
            newJs = newJs.replace(/\/\*[\s\S]*?\*\//g, '');
            newJs = newJs.replace(/\/\/.*/g, '');
            currentJs = newJs;
            addMessage("Updated JavaScript:");
            addMessage("```javascript\n" + currentJs + "\n```");
        }

        async function handleQuestion() {
            const userMessage = userInput.value.trim();
            if (userMessage) {
                addMessage(userMessage, true);
            }
            userInput.value = '';
            const prompt = `Based on the following project context and user input, generate a relevant clarifying question about the project:

            Project context:
            ${projectContext}

            User input:
            ${userMessage}

            Clarifying question:`;
            const question = await generateContent(prompt);
            addMessage(question);
        }

        async function handleImplementationAdvice() {
            const userMessage = userInput.value.trim();
            if (userMessage) {
                addMessage(userMessage, true);
            }
            userInput.value = '';
            const prompt = `Based on the following project context, generated code, and user input, provide advice on how to implement and run this project. Include information about whether a local server is needed, any necessary setup steps, and how to view or interact with the project. If there are multiple files, explain how they should be organized and linked.

            Project context:
            ${projectContext}

            Current HTML:
            ${currentHtml}

            Current CSS:
            ${currentCss}

            Current JavaScript:
            ${currentJs}

            User input:
            ${userMessage}

            Implementation advice:`;

            const advice = await generateContent(prompt);
            addMessage("Implementation Advice:");
            addMessage(advice);
        }

        sendButton.addEventListener('click', handleSend);
        htmlButton.addEventListener('click', handleHtml);
        cssButton.addEventListener('click', handleCss);
        jsButton.addEventListener('click', handleJs);
        questionButton.addEventListener('click', handleQuestion);
        implementationButton.addEventListener('click', handleImplementationAdvice);

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSend();
            }
        });

        modeToggle.addEventListener('change', () => {
            const mode = modeToggle.checked ? 'Smart' : 'Quick';
            addMessage(`Switched to ${mode} mode (${getCurrentModel()})`, false);
        });

        settingsButton.onclick = () => settingsModal.style.display = 'block';
        closeButton.onclick = () => settingsModal.style.display = 'none';
        window.onclick = (event) => {
            if (event.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
        };

        saveSettingsButton.onclick = async () => {
            const repoPath = gitRepoPathInput.value.trim();
            if (repoPath) {
                try {
                    const response = await fetch('/set-git-repo', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ repoPath })
                    });
                    const data = await response.json();
                    alert(data.message);
                    addGitContextButton.style.display = 'block';
                    settingsModal.style.display = 'none';
                } catch (error) {
                    console.error('Error setting Git repository path:', error);
                    alert('Error setting Git repository path');
                }
            }
        };

        addGitContextButton.onclick = async () => {
            try {
                const response = await fetch('/git-repo-content');
                gitRepoContent = await response.json();
                const gitContextMessage = `Git repository content added to context. Repository structure:\n${JSON.stringify(gitRepoContent, null, 2)}`;
                addMessage(gitContextMessage, true);
                projectContext += gitContextMessage + '\n';
            } catch (error) {
                console.error('Error fetching Git repository content:', error);
                alert('Error fetching Git repository content');
            }
        };

        addMessage("Hello! I'm here to help you with your project. What would you like to do?");
    </script>
</body>
</html>